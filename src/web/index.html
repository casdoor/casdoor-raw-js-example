<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div class="login" style="margin:0 auto;width: 200px; text-align: center;">
    <div style="width: 200px ;height:100px;">
      <button id="signIn" style="width: 200px;height: 50px;">sign in</button>
      <button id="signUp" style="width: 200px;height: 50px">sign up</button>
    </div>
    <table style="border:1px solid #ccc;width: 200px;border-radius: 5px;" id="userInfoTable">
      <thead>
        <tr>
          <td style="border:2px solid #ccc ;">userinfo</td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <img id="avatar" width="50px" height="50px" />
          </td>
        </tr>
        <tr>
          <td>
            <section class="username">username</section>
          </td>
        </tr>
        <tr>
          <td>
            <section class="email">email</section>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!--init the SDK-->
  <script type="module">
    //Import from cdn(you can choose the appropriate cdn source according to your needs), or just from the local(download the casdoor-js-sdk first)
    import SDK from 'https://unpkg.com/casdoor-js-sdk@latest/lib/esm/sdk.js'
    const sdkConfig = {
      serverUrl: "http://localhost:8000",
      clientId: "06effe8f48f0047c7462",
      appName: "app-built-in",
      organizationName: "built-in",
      redirectPath: "/",
    }
    window.sdk = new SDK(sdkConfig)
  </script>
  <script type="text/javascript">
    window.addEventListener('load', () => {
      if (window.location.href.indexOf('code') !== -1) {
        let usernameElement = document.querySelector(".username")
        let avatarElement = document.querySelector("#avatar");
        let emailElement = document.querySelector(".email");
        let loginBox = document.querySelector(".login");


        let signOutButton = document.createElement("button");
        signOutButton.innerText = "signOut";
        loginBox.insertBefore(signOutButton, null);

        signOutButton.addEventListener("click", signOut);

        if (!sessionStorage.getItem('token')) {
          sdk.signin("http://localhost:8080").then(res => {
            sessionStorage.setItem('token', res.token);
          });
        }
        async function getInfo() {
          let token = sessionStorage.getItem('token');
          if (!token) return;
          return fetch(`http://localhost:8080/api/getUserInfo?token=${token}`).then(res => res.json());
        }

        getInfo().then(res => {
          setInfo(res);
        });

        function setInfo(res) {
          let userinfo = res;
          usernameElement.innerHTML = userinfo.displayName || userinfo.name;
          avatarElement.src = userinfo.avatar;
          avatarElement.innerText = " ";
          emailElement.innerHTML = userinfo.email || 'not set';
        }

        function signOut() {
          sessionStorage.removeItem("token");
          window.location.href = "http://localhost:8080";
        }
      };
      //get the element
      const signInBtn = document.querySelector("#signIn");
      const signUpBtn = document.querySelector("#signUp");
      function gotoSignInPage() {
        window.location.href = sdk.getSigninUrl();
      }
      function gotoSignUppage() {
        window.location.href = sdk.getSignupUrl();
      }
      signInBtn.addEventListener("click", gotoSignInPage);
      signUpBtn.addEventListener("click", gotoSignUppage);
    })
  </script>
</body>

</html>